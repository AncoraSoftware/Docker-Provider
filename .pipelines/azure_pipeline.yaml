# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- ci_dev

pool:
  name: Azure-Pipelines-CI-Prod-EO

variables:
  armServiceConnectionName: 'ci-1es-acr-connection-prod'
  subscription: '30c56c3a-54da-46ea-b004-06eb33432687'
  containerRegistry: 'containerinsightsbuild'
  repoImageName: '${{ variables.containerRegistry }}.azurecr.io/official/build'

steps:
- task: AzureCLI@2
  inputs:
    azureSubscription: ${{ variables.armServiceConnectionName }}
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      pwd
      ls -ltr

      commit=$(git rev-parse --short HEAD)
      echo "##vso[task.setvariable variable=commitID;isOutput=true;]$commit"

      datetime=$(date +'%Y%m%d%s')
      echo "##vso[task.setvariable variable=datetime;isOutput=true;]$datetime"

      sudo apt-get update && sudo apt-get -y install qemu binfmt-support qemu-user-static
      docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      docker buildx create --name testbuilder
      docker buildx use testbuilder

      az --version
      az account show
      az account set -s ${{ variables.subscription }}
      az acr login -n ${{ variables.containerRegistry }}

      docker buildx build --platform linux/amd64,linux/arm64 --tag '${{ variables.repoImageName }}:cidev-${{ variables.$datetime }}-${{ variables.commit }}' -f kubernetes/linux/Dockerfile.multiarch --push .
